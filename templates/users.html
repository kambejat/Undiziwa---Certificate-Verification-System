{% extends "layout.html" %} {% block title %}Users{% endblock %} {% block
content %}


<div class="bg-gray-50 min-h-screen p-4">
  <!-- Toast Notification -->
  <div id="toast" class="fixed top-4 right-4 px-4 py-2 rounded shadow hidden">
    <span id="toast-message"></span>
  </div>

  <div class="max-w-7xl mx-auto bg-white shadow rounded-md p-4">
    <div class="flex justify-between mb-4">
      <h2 class="text-2xl font-semibold">Users</h2>
      <button id="open-create-modal"
        class="bg-green-700 text-white px-4 py-2 rounded hover:bg-green-900 flex items-center space-x-1">
        <i class="fas fa-plus"></i>
        <span>Create User</span>
      </button>

      <!-- Search -->
      <input id="search-Input" type="text" placeholder="Search users..." class="p-2 border rounded w-64" />
    </div>

    <!-- Filters -->
    <div class="flex gap-4 mb-4">
      <select id="filter-role" class="p-2 border rounded">
        <option value="">All Roles</option>
        <option value="hr">HR</option>
        <option value="institution_admin">Institution Admin</option>
        <option value="gov_admin">Gov Admin</option>
        <option value="super_admin">Super Admin</option>
      </select>

      <select id="filter-status" class="p-2 border rounded">
        <option value="">All Status</option>
        <option value="true">Active</option>
        <option value="false">Inactive</option>
      </select>
    </div>

    <!-- Users Table -->
    <table class="min-w-full divide-y divide-gray-200" id="users-table">
      <thead class="bg-gray-100 border-b">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            ID
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            <i class="fas fa-user mr-1"></i> Username
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            <i class="fas fa-envelope mr-1"></i> Email
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            <i class="fas fa-user-shield mr-1"></i> Role
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            <i class="fas fa-info-circle mr-1"></i> Status
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium uppercase">
            <i class="fas fa-cogs mr-1"></i> Actions
          </th>
        </tr>

      </thead>
      <tbody id="users-body" class="bg-white divide-y divide-gray-200">
        <!-- Rows rendered by JS -->
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="flex justify-between mt-4">
      <button id="prev-page" class="px-4 py-2 bg-gray-300 rounded flex items-center space-x-1">
        <i class="fas fa-chevron-left"></i><span>Prev</span>
      </button>
      <span>Page <span id="current-page"></span> of <span id="total-pages"></span></span>
      <button id="next-page" class="px-4 py-2 bg-gray-300 rounded flex items-center space-x-1">
        <span>Next</span><i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- Modal: Set User Permissions -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-md shadow-lg w-96">
      <h3 class="text-xl font-semibold mb-2">Set User Permissions</h3>
      <p id="modal-user-fullname" class="text-gray-700 mb-4 font-medium"></p>

      <div class="mb-3 relative">
        <label class="block mb-1">Role:</label>
        <select id="modal-role" class="w-full p-2 border rounded pl-10">
          <option value="hr">HR</option>
          <option value="institution_admin">Institution Admin</option>
          <option value="gov_admin">Gov Admin</option>
          <option value="super_admin">Super Admin</option>
        </select>
        <i class="fas fa-user-shield absolute left-3 top-3 text-gray-400"></i>
      </div>

      <div class="mb-3 relative">
        <label class="block mb-1">Active Status:</label>
        <select id="modal-status" class="w-full p-2 border rounded pl-10">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
        <i class="fas fa-toggle-on absolute left-3 top-3 text-gray-400"></i>
      </div>

      <!-- Modal Buttons -->
      <div class="flex justify-between mt-6 space-x-2">
        <button id="modal-cancel" class="px-4 py-2 bg-gray-300 rounded flex items-center space-x-1">
          <i class="fas fa-times"></i><span>Cancel</span>
        </button>
        <button id="modal-save" class="px-4 py-2 bg-blue-700 text-white rounded flex items-center space-x-1">
          <i class="fas fa-save"></i><span>Save</span>
        </button>
        <button id="modal-reset" class="px-4 py-2 bg-yellow-600 text-white rounded flex items-center space-x-1">
          <i class="fas fa-key"></i><span>Reset Password</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Create User -->
  <div id="create-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-md shadow-lg w-96">
      <h3 class="text-xl font-semibold mb-4">Create User</h3>

      <div class="relative">
        <input id="create-username" class="w-full p-2 pl-10 border rounded mb-2" placeholder="Username" />
        <i class="fas fa-user absolute left-3 top-2.5 text-gray-400"></i>
      </div>

      <div class="relative">
        <input id="create-fullname" class="w-full p-2 pl-10 border rounded mb-2" placeholder="Full Name" />
        <i class="fas fa-id-badge absolute left-3 top-2.5 text-gray-400"></i>
      </div>

      <div class="relative">
        <input id="create-email" class="w-full p-2 pl-10 border rounded mb-2" placeholder="Email" />
        <i class="fas fa-envelope absolute left-3 top-2.5 text-gray-400"></i>
      </div>

      <div class="relative">
        <input id="create-phone" class="w-full p-2 pl-10 border rounded mb-2" placeholder="Phone" />
        <i class="fas fa-phone absolute left-3 top-2.5 text-gray-400"></i>
      </div>

      <div class="relative">
        <input id="create-password" type="password" class="w-full p-2 pl-10 border rounded mb-2"
          placeholder="Password" />
        <i class="fas fa-lock absolute left-3 top-2.5 text-gray-400"></i>
      </div>

      <div class="relative mb-2">
        <select id="create-institution" class="w-full p-2 border rounded pl-10">
          <option value="">Select Institution</option>
        </select>
        <i class="fas fa-university absolute left-3 top-3 text-gray-400"></i>
      </div>

      <div class="relative mb-2">
        <select id="create-role" class="w-full p-2 border rounded pl-10">
          <option value="">Select Role</option>
          <option value="hr">HR</option>
          <option value="institution_admin">Institution Admin</option>
          <option value="gov_admin">Gov Admin</option>
          <option value="super_admin">Super Admin</option>
        </select>
        <i class="fas fa-user-shield absolute left-3 top-3 text-gray-400"></i>
      </div>

      <div class="relative mb-4">
        <select id="create-status" class="w-full p-2 border rounded pl-10">
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
        <i class="fas fa-toggle-on absolute left-3 top-3 text-gray-400"></i>
      </div>

      <div class="flex justify-between mt-2 space-x-2">
        <button id="create-cancel" class="px-4 py-2 bg-gray-300 rounded flex items-center space-x-1">
          <i class="fas fa-times"></i><span>Cancel</span>
        </button>
        <button id="create-save" class="px-4 py-2 bg-green-700 text-white rounded flex items-center space-x-1">
          <i class="fas fa-user-plus"></i><span>Create</span>
        </button>
      </div>
    </div>
  </div>
</div>



<script>
  const users = {{ users| tojson | safe }};
  const currentUserRole = '{{ session.get("role") or "" }}';

  let page = 1;
  const pageSize = 10;
  let filteredUsers = [...users];
  let currentUser = null;

  // DOM elements
  const usersBody = document.getElementById('users-body');
  const searchInput = document.getElementById('search-Input');
  const filterRole = document.getElementById('filter-role');
  const filterStatus = document.getElementById('filter-status');
  const prevPageBtn = document.getElementById('prev-page');
  const nextPageBtn = document.getElementById('next-page');
  const currentPageEl = document.getElementById('current-page');
  const totalPagesEl = document.getElementById('total-pages');
  const toastEl = document.getElementById('toast');
  const toastMessage = document.getElementById('toast-message');
  const modal = document.getElementById('modal');
  const modalRole = document.getElementById('modal-role');
  const modalStatus = document.getElementById('modal-status');
  const modalCancel = document.getElementById('modal-cancel');
  const modalSave = document.getElementById('modal-save');
  const modalReset = document.getElementById('modal-reset');

  function showToast(message, isError = false) {
    toastMessage.textContent = message;
    toastEl.className = isError ? 'fixed top-4 right-4 px-4 py-2 rounded shadow bg-red-600 text-white' :
      'fixed top-4 right-4 px-4 py-2 rounded shadow bg-green-700 text-white';
    toastEl.style.display = 'block';
    setTimeout(() => toastEl.style.display = 'none', 2500);
  }

  function renderTable() {
    usersBody.innerHTML = '';

    const start = (page - 1) * pageSize;
    const paginated = filteredUsers.slice(start, start + pageSize);
    paginated.forEach(user => {
      const tr = document.createElement('tr'); // <-- THIS WAS MISSING
      tr.className = 'hover:bg-blue-50';

      const userId = user.user_id ?? '';
      const username = user.username ?? '';
      const email = user.email ?? '';
      const role = user.role ?? '';
      const isActive = user.is_active ?? false;
      tr.innerHTML = `
  <td class="px-6 py-4">${userId}</td>
  <td class="px-6 py-4">${username}</td>
  <td class="px-6 py-4">${email}</td>
  <td class="px-6 py-4 uppercase">${role}</td>
  <td class="px-6 py-4">
    <span class="px-3 py-1 rounded text-white text-sm flex items-center space-x-1 ${isActive ? 'bg-green-900' : 'bg-red-900'
        }">
      <i class="fas ${isActive ? 'fa-check-circle' : 'fa-times-circle'}"></i>
      <span>${isActive ? 'Active' : 'Inactive'}</span>
    </span>
  </td>
  <td class="px-6 py-4">
    ${['super_admin', 'gov_admin'].includes(currentUserRole)
          ? `<button class="bg-blue-700 text-white px-3 py-1 rounded hover:bg-blue-900 flex items-center space-x-1 manage-btn">
            <i class="fas fa-user-cog"></i>
            <span>Manage</span>
          </button>`
          : ''
        }
  </td>
`;
      // Attach Manage button listener
      const manageBtn = tr.querySelector('.manage-btn');
      if (manageBtn) {
        manageBtn.addEventListener('click', () => openModal(user));
      }

      usersBody.appendChild(tr);
    });
    currentPageEl.textContent = page;
    totalPagesEl.textContent = Math.ceil(filteredUsers.length / pageSize);

    prevPageBtn.disabled = page === 1;
    nextPageBtn.disabled = page === Math.ceil(filteredUsers.length / pageSize);
  }

  function filterUsers() {
    const searchTerm = searchInput.value.toLowerCase();
    const role = filterRole.value;
    const status = filterStatus.value;

    filteredUsers = users.filter(u => {
      const username = u.username || '';
      const email = u.email || '';

      const matchesSearch = username.toLowerCase().includes(searchTerm) || email.toLowerCase().includes(searchTerm);
      const matchesRole = role ? u.role === role : true;
      const matchesStatus = status ? Boolean(u.is_active) === (status === 'true') : true;

      return matchesSearch && matchesRole && matchesStatus;
    });
    page = 1;
    renderTable();
  }

  searchInput.addEventListener('input', filterUsers);
  filterRole.addEventListener('change', filterUsers);
  filterStatus.addEventListener('change', filterUsers);

  prevPageBtn.addEventListener('click', () => { page--; renderTable(); });
  nextPageBtn.addEventListener('click', () => { page++; renderTable(); });

  // Modal functions
  function openModal(user) {
    currentUser = user;
    modal.style.display = 'flex';

    modalRole.value = user.role;
    modalStatus.value = user.is_active.toString();

    const fullnameSpan = document.getElementById("modal-user-fullname");
    if (fullnameSpan) {
      fullnameSpan.textContent = `User: ${user.full_name}`;
    }
  }

  modalCancel.addEventListener('click', () => { modal.style.display = 'none'; });
  modalSave.addEventListener('click', async () => {
    if (!currentUser) return;
    const payload = {
      role: modalRole.value,
      is_active: modalStatus.value === 'true'
    };
    const response = await fetch(`/users/${currentUser.user_id}/permission`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      const updated = await response.json();
      const index = users.findIndex(u => u.user_id === updated.user_id);
      users[index] = updated;
      filterUsers();
      modal.style.display = 'none';
      showToast('Permissions updated');
    } else {
      showToast('Failed to update user', true);
    }
  });

  modalReset.addEventListener('click', async () => {
    if (!currentUser) return;
    const confirmReset = confirm("Reset this user's password to a new random password?");
    if (!confirmReset) return;

    const response = await fetch(`/users/${currentUser.user_id}/reset-password`, { method: 'PATCH' });
    if (response.ok) {
      showToast('Password reset successfully');
    } else {
      showToast('Reset failed', true);
    }
  });

  const createModal = document.getElementById('create-modal');
  const openCreateBtn = document.getElementById('open-create-modal');
  const createCancel = document.getElementById('create-cancel');
  const createSave = document.getElementById('create-save');

  openCreateBtn.addEventListener('click', () => {
    createModal.style.display = 'flex';
    loadInstitutions();
  });

  createCancel.addEventListener('click', () => {
    createModal.style.display = 'none';
  });

  async function loadInstitutions() {
    const institutionSelect = document.getElementById('create-institution');
    if (!institutionSelect) return;

    try {
      const response = await fetch('/institutions/json');
      if (!response.ok) throw new Error('Failed to load institutions');

      const institutions = await response.json();

      institutions.forEach(inst => {
        const option = document.createElement('option');
        option.value = inst.id;
        option.textContent = inst.name;
        institutionSelect.appendChild(option);
      });
    } catch (err) {
      console.error(err);
      showToast('Unable to load institutions', true);
    }
  }


  createSave.addEventListener('click', async () => {
    const payload = {
      username: document.getElementById('create-username').value.trim(),
      full_name: document.getElementById('create-fullname').value.trim(),
      email: document.getElementById('create-email').value.trim(),
      phone: document.getElementById('create-phone').value.trim(),
      password: document.getElementById('create-password').value,
      role: document.getElementById('create-role').value,
      is_active: document.getElementById('create-status').value === 'true'
    };


    // Institution ID (only if selector exists)
    const institutionSelect = document.getElementById('create-institution');
    if (institutionSelect && institutionSelect.value) {
      payload.institution_id = parseInt(institutionSelect.value);
    }

    // Validation
    if (!payload.username || !payload.email || !payload.role) {
      showToast('Please fill required fields', true);
      return;
    }

    const response = await fetch('/users', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      const newUser = await response.json();
      users.unshift(newUser);
      filterUsers();
      createModal.style.display = 'none';
      showToast('User created successfully');
    } else {
      const err = await response.json().catch(() => ({}));
      showToast(err.message || 'Failed to create user', true);
    }
  });

  // Initial render
  renderTable();
</script>

{% endblock %}